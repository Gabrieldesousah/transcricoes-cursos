# Protegendo área do professor

Mesmo que não tenha resposta nenhuma, caso exista um aluno mal intensionado ele conseguiria enviar uma requisição para tentar identificar as turmas de um determinado professor.

Para resolver este problema trabalharemos com o conceito de habilidades, que é muito simples e você já aprendeu em módulos anteriores.

Criaremos mais uma habilidade para impedir que alunos possam tentar acessar dados que somente professores deveriam acessar.

Abra o arquivo **/app/Providers/AuthServiceProvider.php**.

```php
    public function boot()
    {
        \Gate::define('teacher', function($user) {
            return $user->userable instanceof Teacher;
        });
    }
```

Adicione a habilidade **teacher** que retorna somente se o usuário for uma instância do model **Teacher**.

Depois de criar a habilidade temos que adicionar o middleware à rota. Abra o arquivo **/routes/api.php**.

```php
Route::group(['middleware' => 'auth.renew'], function () {
    Route::get('/user', function (Request $request) {
        return \Auth::user();
    });
    Route::group([
        'prefix' => 'teacher', 
        'as' => 'teacher.', 
        'namespace' => 'Teacher\\',
        'middleware' => 'can:teacher'
    ], function(){
        Route::resource('class_informations', 'ClassInformationsController', ['only' => ['index', 'show']]);
    });
});
```

Vejam que o middleware **can:teacher** está fazendo a segurança de nossa rota para que alunos não consigam acessá-las. A diretiva **can** testa a habilidade que criamos anteriormente.

Para fazer um teste de acesso de aluno precisaremos criar um aluno teste, assim como criamos o professor teste. Portanto abra o arquivo **/database/seeds/UsersTableSeeder.php**.

```php
factory(\SON\Models\User::class)->create([
    'email' => 'student@user.com',
    'enrolment' => 700000,
])->each(function(User $user){
    $profile = factory(UserProfile::class)->make();
    $user->profile()->create($profile->toArray());
    User::assignRole($user, User::ROLE_STUDENT);
    $user->save();
});
```

Depois de adicionar este código à seeder **UsersTableSeeder.php**, devemos rodar o comando para gerar novamente os usuários.

```sh
php artisan migrate:refresh --seed
```

Agora acesse o sistema, como aluno, e tente acessar a listagem de turmas com a mesma requisição do professor para você identificar o erro com status code **403**. Teremos uma página de erro **unauthorized**, mas não iremos nos preocupar em retornar um json para este caso.

O importante é o aluno não conseguir ter acesso a listagem de turmas do professor, simplesmente por ele não ser um professor.

Neste caso o middleware está desempenhando seu papel corretamente.