# Proteção da área interna do SPA

Neste módulo faremos a proteção do SPA de forma que somente professores e alunos possam ter acesso.

A forma que utilizaremos para proteger esta área será verificando o token no local storate. Você pode estar imaginando que o usuário, sabendo desta informação, pode adicionar qualquer valor no token e ter acesso ao frontend.

Não se preocupe com o usuário acessar o frontend da aplicação porque qualquer outra funcionalidade que ele tente fazer, consultando a API, ele não terá sucesso e o servidor retornará um erro 401 sem um token válido.

Para adicionar uma segurança a mais em sua aplicação você poderia verificar a validade do token no frontend, mas isso ficaria como uma tarefa a mais para praticar, pois se fizéssemos esta etapa em nosso conteúdo perderíamos o foco do que realmente queremos atingir.

Falando novamente na proteção da área interna teremos que verificar se existe um token para liberar o acesso ao usuário, seja ele professor ou aluno.

Lembrando que em nosso armazem, na constante **state**, temos a propriedade **check** que guarda o token de autenticação. Portanto seria simples para verificarmos se o usuário está ou não autenticado, basta acessar esta propriedade a cada página que o usuário for acessar.

Quando trabalhamos com **vue-router** temos um recurso, que trabalha como um interceptor nas rotas, chamado **beforeEach**. Isso quer dizer que vamos conferir o token antes de que cada página seja renderizada. Também devemos verificar se a página é realmente protegida, pois pode se tratar de uma página liberada para qualquer usuário sem autenticação.

Para verificar se a rota é protegida ou não devemos adicinar um tipo de identificação em cada rota, assim o sistema poderá identificar a proteção ou liberação da mesma. Para isso abra o arquivo **/resources/assets/spa/js/router.map.js**.

```js
export default [
    {
        name: 'class_informations.list',
        path: '/classes',
        component: require('./components/teacher/TeacherClassInformationList.vue'),
        meta: {
            auth: true
        }
    },
    {
        name: 'login',
        path: '/login',
        component: require('./components/Login.vue')
    },
    { path: '*', redirect: '/login' }
];
```

Vejam que na rota **class_informations.list** adicionamos a propriedade meta. Esta propriedade é um objeto que pode ter várias informações, porém só adicionamos uma propriedade **auth** com valor true.

A rota login não precisa ser protegida então não adicionamos. À partir de agora devemos adicionar a propriedade meta em todas as rotas protegidas.

Agora entra o papel do vue-router com o método beforeEach. Abra o arquivo **/resources/assets/spa/js/router.js**.

```js
import Vue from "vue";
import VueRouter from "vue-router";
import routes from "./router.map";
import AppComponent from "./components/App.vue";
import store from "./store/store";

const router = new VueRouter({
    routes
});

router.beforeEach((to, from, next) => {
    if(to.meta.auth && !store.state.auth.check){
        return router.push({name: 'login'})
    }
    next();
});

new Vue({
    router,
    el: '#app',
    components: {
        'app': AppComponent
    }
});

export default router;
```

Este método vai analisar a nossa lógica e tomara a decisão de continuar o processamento ou redirecionar o usuário para o login, para que ele possa se autenticar antes de prosseguir.

Analise somente o código que adicionamos ao arquivo, lembrando que é necessário importante o **store** para que não tenha erro.

```js
router.beforeEach((to, from, next) => {
    if(to.meta.auth && !store.state.auth.check){
        return router.push({name: 'login'})
    }
    next();
});
```

Vejam que existe uma condicional que analisa primeiro se a rota é protegida.

O parâmetro **to** tem acesso aos dados da rota e por isso conseguimos acessar a nossa propriedade meta.

Quando a condicional verifica a proteção da rota exige que o usuário tenha um token, caso o mesmo **não** possua a função redireciona o usuário para o login, caso contrário continua o processamento da rota com a função **next**.

```js
if(to.meta.auth && !store.state.auth.check){
    return router.push({name: 'login'})
}
```

Depois de fazer estas alterações certifique-se de que não exista nenhum token no local storage, ou seja, que você não está autenticado e tente acessar a rota **http://localhost:3000/app#/classes**. Você deverá ser redirecionado para o login para que possa se autenticar, caso isso ocorra atingimos nosso objetivo.

Este recurso do vue-router está na documentação e facilita nossa vida, pois em apenas três linhas de código conseguimos proteger todas as nossas rotas internas. Lembrando que devemos adicionar a propriedade meta em toda rota que deve ser protegida.