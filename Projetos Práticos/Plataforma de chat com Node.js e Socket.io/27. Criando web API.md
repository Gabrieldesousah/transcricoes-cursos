# Criando web API

O objetivo de nossa API é buscar os dados, já cadastrados, no banco e fornecer estes dados formatados para quem a acessar.

Em nosso projeto inicial temos duas rotas cadastradas inicialmente, mas faremos algumas alterações. Vejam as rotas cadastradas no arquivo **api/app.js**:

```js
app.use('/', index);
app.use('/users', users);
```

A primeira rota aponta para o arquivo **routes/index.js** e a segunda para **routes/users.js**.

A alterção que faremos, na estrutura inicial, consiste em remover estas rotas e carregamentos iniciais. Veja as alterações:

Remover:

```js
var index = require('./routes/index');
var users = require('./routes/users');

app.use('/', index);
app.use('/users', users);
```

Adicione:

```js
// já adicionado no módulo anterior
mongoose.connect('mongodb://127.0.0.1:27017/chatschool_dev');

require('./routes')(app);
```

Estamos carregando o arquivo **routes.js** que deve estar na pasta raiz de nossa API. Como este arquivo ainda não existe crie-o e adicione o seguinte código:

```js
module.exports = (app) => {
    app.use('/users', require('./routes/users'))
    app.use('/rooms', require('./routes/rooms'))
}
```

Estamos registrando as rotas e já fazendo o carregamento dos arquivo diretamente. Estamos carregando os arquivos dentro das pastas **routes/users** e **routes/rooms**, que ainda não existem. Como não estamos passando nome de nenhum arquivo, automaticamente será carregado o arquivo index.js, dentro de cada pasta desta.

Portando apague os arquivos originais, que estão dentro da pasta *routes*, crie as pastas acima e um arquivo index.js dentro de cada uma delas.

> Conteúdo do arquivo **routes/users/index.js** e **routes/rooms/index.js**

```js
var express = require('express');
var router = express.Router();

router.get('/', require('./find'))

module.exports = router
```

O conteúdo dos dois arquivos são exatamente iguais para este momento.

Agora crie os arquivos **routes/users/find.js** e **routes/rooms/find.js**, pois quando o usuário acessar a rota raiz é este arquivo que será chamado, conforme código acima.

Chegamos a um ponto que precisaremos utilizar o mongoose e para manipula os dados no banco precisamos de uma **schema**. Em nossa API ainda não criamos estes *models*, mas já temos criado no seção de admin, dos módulos anteriores.

Replicaremos estes mesmos models, mas agora faremos com que possam retornar os valores no formato de uma linguagem universal.

Então crie uma pasta, chamada **model**, dentro de sua pasta raiz, ou seja, no mesmo nível que a pasta **routes**. Dentro desta pasta crie dois arquivos: **users.js** e **rooms.js**.

Depois disso copie os dados do model, da nossa seção de admin, e cole nestes arquivos. Veja abaixo:

```js
// users.js
var mongoose = require('mongoose')
//const passportLocalMongoose = require('passport-local-mongoose')

const User = new mongoose.Schema({
    name: {
        type: String,
        required: true
    },
    slug: {
        type: String,
        required: true
    },
    email: {
        type: String,
        required: true
    },
    password: {
        type: String,
        required: true
    }
})

//User.plugin(passportLocalMongoose, { usernameField: 'email' })

module.exports = mongoose.model('User', User);
```

```js
// rooms.js
const mongoose = require('mongoose')

const Rooms = new mongoose.Schema({
    name: {
        type: String,
        required: true
    },
    slug: {
        type: String,
        required: true
    },
    description: {
        type: String,
        required: true
    },
    enable: {
        type: Boolean,
        required: true,
        default: true
    },
    users: [{
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Users'
    }],
    created: {
        type: Date,
        required: true,
        default: new Date()
    }
})

module.exports = mongoose.model('Rooms', Rooms)
```

Agora que já temos os models criados basta criarmos os arquivos **find.js** que serão responsáveis por retornar os dados encontrados no banco em formato **json**.

> Conteúdo do arquivo **routes/users/find.js**

```js
var Users = require('./../../model/users');

module.exports = (req, res) => {
    Users
        .find({})
        .then((users) => {
            if(!users){
                return res
                    .status(404)
                    .json({
                        status: false,
                        users
                    })
            }

            return res
                .status(200)
                .json({
                    status: true,
                    users
                })
        })
        .catch((error) => {
            return res
                .status(500)
                .json({
                    status: false,
                    error
                })
        })
}

```

> Conteúdo do arquivo **routes/rooms/find.js**

```js
var Rooms = require('./../../model/rooms');

module.exports = (req, res) => {
    Rooms
        .find({})
        .then((rooms) => {
	        if(!rooms){
		        return res
		            .status(404)
		            .json({
		                status: false,
		                rooms
		            })
		    }

		    return res
		        .status(200)
		        .json({
		            status: true,
		            rooms
		        })
		})
		.catch((error) => {
	        return res
	            .status(500)
	            .json({
	                status: false,
	                error
	            })
	    })
}
```

Já criamos os endpoints, os models e estamos com o mongoose funcionando, então basta acessar as urls abaixo e já teremos os resultados retornados:

**http://localhost:3000/users**

**http://localhost:3000/rooms**

Caso precisemos de mais rotas, para buscar dados diferentes, criaremos durante o decorrer do conteúdo.

O mais importante é que nossa API está criada e retornando dados que precisamos, agora daremos continuidade ao desenvolvimento.