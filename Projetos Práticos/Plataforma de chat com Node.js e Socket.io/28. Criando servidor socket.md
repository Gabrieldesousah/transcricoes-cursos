# Criando servidor socket

Criamos a nossa Web API, agora chegou a hora de trabalhar com o protocólo web sockets.

Para este procedimento utilizaremos o **socket.io**, como havíamos dito anteriormente. O projeto socket.io tem como função abstrair a parte de conexão e envio de dados, de uma forma bem simples de trabalhar.

Criaremos agora o servidor web socket e mostraremos como podemos interagir com ele.

Faremos algumas alterações no projeto atual da nossa API, mas antes disso teremos que instalar o pacote socket.io.

`npm install socket.io --save`

Depois de instalar o pacote começaremos a fazer nossas alterações e começaremos pelo arquivo **api/app.js**.

```js
// Código já existente
var app = express();

// Código adicionado
var server = require('http').Server(app);
var io = require('socket.io')(server);

// Código alterado no final do arquivo (altere)
module.exports = {
    app: app,
    server: server
};
```

Criamos o servidor HTTP e o servidor socket.io diretamente no arquivo app.js. Anteriormente o servidor HTTP era criado no arquivo **./bin/www** ao rodar o comando **npm start**.

Anteriormente o arquivo app.js só exportava uma instância **app**, agora estamos exportando um objeto com duas propriedades: *app* e *server*.

### Arquivo ./bin/www.js

```js
// Alteração para variável app
var app = require('../app').app;

// Alteração para variável server
var server = require('../app').server;
```

Estamos alterando a forma de carregas as duas variáveis acima, faça estas alterações.

Depois disso nós acrescentaremos, a cada resposta de requisição, o nosso servidor socket.io. Faremos isso criando um middleware. Veja o código do arquivo app.js:

```js
// já existente
mongoose.connect('mongodb://127.0.0.1:27017/chatschool_dev');

// código adicionado
app.use((req, res, next) => {
    res.io = io;
    next();
});

// já existente
require('./routes')(app);
```

Depois de adicionar este código você já pode reiniciar nosso servidor com `npm start` e já teremos tudo pronto para continuar desenvolvendo, mas agora com nossos servidores criados e aptos a retornar dados utilizando o protocólo socket.io.

Já podemos começar a interagir, em tempo real, junto com o servidor próprio de websocket e também webserver.