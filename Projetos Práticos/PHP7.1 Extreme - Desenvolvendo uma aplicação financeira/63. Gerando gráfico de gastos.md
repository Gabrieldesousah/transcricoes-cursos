# Gerando gráfico de gastos

Neste módulo terminaremos a estrutura de gráficos e também testaremos.

Para geração dos gráficos utilizaremos a ferramenta **Google Charts**. Uma ferramenta fantástica e profissional para a criação de gráficos.

Existe uma infinidade de tipos de gráficos que esta ferramenta nos possibilita criar. Conseguimos gerar gráficos para rodar no browser, tables e outros dispositivos móveis.

É muito simples trabalhar com esta biblioteca, mas ela é muito detalhista e específica. Temos uma documentação muito grande a ser consultada, mas tentaremos trabalhar de uma forma bem simples para que entenda apenas o que precisaremos.

Resumindo podemos falar que carregaremos um javascript em nossa página, depois carregaremos o pacote dos gráficos e depois escolhemos o tipo de gráfico que montaremos, seguido dos dados a serem inseridos ao gráfico.

Nós só conseguimos gerar o gráfico se tivermos internet, porque todo processo fará buscas no servidor do google e também terá todo conteúdo carregado de forma online para geração dos mesmos.

> #### Comentando processo

Estamos trabalhando com twig e precisaremos carregar o javascript do google, para a criação dos gráficos, então veja como faremos:

Em primeiro lugar criaremos mais um bloco em nosso layout principal **tamplates/layout.html.twig**:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>School of Net - SON Finanças</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>
    {% if Auth.check() %}
    <nav class="navbar navbar-default navbar-inverse">
        <div class="container">
            <div class="navbar-header">

                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#app-navbar-collapse">
                    <span class="sr-only">Toggle Navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a class="navbar-brand" href="#">
                    SON Finanças
                </a>
            </div>

            <div class="collapse navbar-collapse" id="app-navbar-collapse">
                <ul class="nav navbar-nav">
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a>{{ Auth.user().fullname }}</a></li>
                    <li><a href="{{ route('auth.logout') }}">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    {% block content %}{% endblock %}    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
```

Criamos um bloco chamado **scripts** para que possamos carregar os recursos do *Google Charts* somente na página que for preciso, assim não carregamos desnecessariamente nos demais templates.

Agora veja como ficará nosso template para a geração dos gráficos:

```html		
{% extends 'layout.html.twig' %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Gráfico de gastos
                    </h3>
                </div>
                <div class="panel-body">
                    <form class="form-inline text-center" method="get" action="{{ route('charts.list') }}">
                        <div class="form-group">
                            <label class="control-label">Início</label>
                            <input class="form-control" type="text" placeholder="DD/MM/YYY"
                                   name="date_start" value="{{ 'now'|date_modify('-1 month')|date('d/m/Y') }}">
                        </div>
                        <div class="form-group">
                            <label class="control-label">Fim</label>
                            <input class="form-control" type="text" placeholder="DD/MM/YYY"
                                   name="date_end" value="{{ 'now'|date('d/m/Y') }}">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="glyphicon glyphicon-search"></span>
                        </button>
                    </form>
                    <div id="chart-div"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {packages: ['corechart']})
        //Google Visualization API
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Categoria');
            data.addColumn('number', 'Valor Gasto');
            data.addRows([
                {% for category in categories %}
                ['{{ category.name }}',{{ category.value|number_format(2,'.','') }}],
                {% endfor %}
            ]);

            var chart = new google.visualization.PieChart(document.getElementById('chart-div'));
            chart.draw(data, {
                width: '100%',
                height: 300
            });
        }
    </script>
{% endblock %}
```

Em primeiro lugar mantivemos o formulário para que o usuário ainda possa escolher a data que ele quer gerar o gráfico.

Depois adicionamos uma div, com um **id**, para que possamos adicionar o gráfico, ou seja, este elemento só serve para marcação inicialmente.

O próximo passo foi adicionar a chamada do loader, que será responsável por carregar o *core* do google charts, pois utilizaremos para a geração dos gráficos.

Depois criamos uma outra tag *script* para que pudessemos começar a desenvolver o gráfico.

O primeiro passo é carregar o método load e passar, como parâmetros, a versão e o pacote que queremos carregar.

```javascript
google.charts.load('current', {packages: ['corechart']})
```

Então estamos carregando a ultima versão, por declarar *current*, e estamos carregando o pacote *corechart*.

Este carregamento será feito de forma assíncrona, portanto não tem como sabermos o momento em que este core será carregado, por este motivo criamos uma forma de garantir que nossa função só seja executada após o carregamento. Veja abaixo:

`google.charts.setOnLoadCallback(drawChart);`

Isso quer dizer que somente após o término do carregamente do core executaremos a função **drawChart**. Veja a função:

```javascript
function drawChart() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Categoria');
    data.addColumn('number', 'Valor Gasto');
    data.addRows([
        {% for category in categories %}
        ['{{ category.name }}',{{ category.value|number_format(2,'.','') }}],
        {% endfor %}
    ]);

    var chart = new google.visualization.PieChart(document.getElementById('chart-div'));
    chart.draw(data, {
        width: '100%',
        height: 300
    });
}
```

Sempre teremos que carregar uma instância de **google.visualization**, para a criação dos gráficos, então começamos acionando o método *Datatable*. Com esta instância nós conseguimos setar os dois eixos de nosso gráfico, como se fosse x e y.

Adicionamos duas colunas, com o método **addColumn**. Coluna *Categoria*, que será do tipo *string* e também a coluna *Valor Gasto*, que será do tipo *number*.

Depois de adicionar as colunas temos que adicionar as linhas, ou resultados, que são os dados que formam o nosso gráfico. Para isso utilizamos o método **addRow** e passamos um array com uma listagem de arrays internos. Cada array interno será um elemento do gráfico.

```javascript
data.addRows([
    {% for category in categories %}
    ['{{ category.name }}',{{ category.value|number_format(2,'.','') }}],
    {% endfor %}
]);
```

Percebam que estamos utilizando a interpolação do Twig para fazer a geração dos arrays internos. A interpolação faz um **for** percorrendo a variável **categories**, que estamos passando para a view, como parâmetro, através de nosso controller e pelo método **sumByPeriod** do repository.

O formato do array deve ser como o exemplo abaixo:

```javascript
['Nome do Campo', 'Valor do Campo']
```

Por este motivo estamos utilizando **category.name** e **category.value**, aplicando o filtro para que possamos ter o valor correto de calculo no javascript.

Depois de formar a estrutra corretamente, temos que fazer a geração do gráfico, no elemento que marcamos em nosso HTML.

```javascript
var chart = new google.visualization.PieChart(document.getElementById('chart-div'));
chart.draw(data, {
    width: '100%',
    height: 300
});
```

Novamente utilizamos uma instância de **google.visualization** acessando o método **PieChart** e passamos o elemento onde queremos adicionar o gráfico.

Depois disso temos que executar o método **draw**, que será responsável por gerar o gráfico, por este motivo temos que passar os dados da variável **data**, que criamos acima, e também um objeto, com algumas configurações. Em nosso caso passamos apenas a largura e a altura que desejamos.

Depois disso o nosso gráfico já deve estar gerado, caso acesse a rota **http://localhost:8000/charts**, porém não se esqueca de carregar a rota no arquivo **public/index.php** antes de acessar.

```php
require_once __DIR__ . '/../src/controllers/charts.php';
```

Para que os gráficos funcionassem corretamente tivemos que fazer alguns ajustes. Porque como não tínhamos adicionado um filtro para não pegar valores nulos, o array de resultados não estava sendo formado corretamente. Também tivemos que adicionar o intervalo de datas que o usuário selecionou, que não tínhamos colocado em nossa busca. Veja as alterações em **CategoryCostRepository.php**:

```php
public function sumByPeriod(string $dateStart, string $dateEnd, int $userId): array
{
    $categories = CategoryCost::query()
        ->selectRaw('category_costs.name, sum(value) as value')
        ->leftJoin('bill_pays', 'bill_pays.category_cost_id', '=', 'category_costs.id')
        ->whereBetween('date_launch', [$dateStart, $dateEnd])
        ->where('category_costs.user_id', $userId)
        ->whereNotNull('bill_pays.category_cost_id')
        ->groupBy('value')
        ->groupBy('category_costs.name')
        ->get();
    return $categories->toArray();
}
```

Os itens adicionados foram: 

```php
->whereBetween('date_launch', [$dateStart, $dateEnd])
->whereNotNull('bill_pays.category_cost_id')
```

Desta forma temos os dados sendo carregados de forma correta e os gráficos também sendo gerados corretamente.

Caso queira se aprofundar mais na biblioteca *Google Charts* você pode ler a documentação e saber mais sobre todos os tipos de gráficos possíveis de serem criados.

***

### Conclusão

Neste módulo chegamos ao fim de nossa lógica de gerenciamento de finanças.

Nos próximos módulos criaremos o menu de navegação e repassaremos o código com **codesniffer**, para depois subir nossa aplicação para produção.