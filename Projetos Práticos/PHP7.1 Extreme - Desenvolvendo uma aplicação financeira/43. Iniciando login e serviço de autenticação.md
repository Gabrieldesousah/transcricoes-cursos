# Iniciando login e serviço de autenticação

Agora que temos um CRUD de usuário completo e funcionando partiremos para a criação da area de login de nossa aplicação. Nesta area o usuário digitará seu email e sua senha.

Com esta implementação não permitiremos que apenas usuários autorizados possam cadastrar novas categorias e usuários. Portanto terá que ter acesso para acessar a area administrativa da aplicação.

### Criando template de login

Dentro da pasta **templates** cria uma pasta chamada **auth** e dentro desta pasta crie o arquivo chamado **login.html.twig**. Veja o conteúdo o arquivo de login.

```html
{% extends 'layout.html.twig' %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        Login
                    </h3>
                </div>
                <div class="panel-body">
                    <form method="post" action="{{ route('auth.login') }}">
                        <div class="form-group">
                            <label class="control-label">E-mail</label>
                            <input class="form-control" type="text" placeholder="E-mail"
                                   name="email">
                        </div>
                        <div class="form-group">
                            <label class="control-label">Password</label>
                            <input class="form-control" type="password" placeholder="Senha"
                                   name="password">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
```

### Criando e registrando controller

Crie um controller chamado **auth.php** dentro da pasta **src/controllers**.

Nós precisamos deste controler para poder criar a rota de login e a rota de autenticação. Este arquivo ficará bem curto, porque teremos apenas duas rotas. Veja o código do controller:

```php
use Psr\Http\Message\ServerRequestInterface;

$app
    ->get('/login', function(ServerRequestInterface $request) use($app){
        $view = $app->service('view.renderer');;
        return $view->render('auth/login.html.twig');
    }, 'auth.show_login_form')
    ->post('/login', function(ServerRequestInterface $request) use($app){
    	// Código autenticação
    }, 'auth.login');
```

Veja que, por enquanto, estamos apenas utilizando a rote do tipo *get* para redirecionar o usuário para o template de login.

Depois de criar o controller precisamos registrar, no arquivo **public/index.php**, assim como os outros.

```php
// Arquivo public/index.php
require_once __DIR__ . '/../src/controllers/category-costs.php';
require_once __DIR__ . '/../src/controllers/users.php';
require_once __DIR__ . '/../src/controllers/auth.php';
```

Desta forma, acessando *http://localhost:8000/login*, já teremos o redirecionamento para o template de login e já teremos o formulário funcionando.

***

### Criando interface de autenticação

Para conseguir fazer a autenticação do usuário utilizaremos o recurso **session** do PHP.

Toda vez que o usuário se autenticar será criada uma sessão, no lado servidor, e gravado um **cookie** no browser do usuário. Este cookie será enviado em toda requisição feita ao servidor e nossa interface será capaz de confirmar se o usuário está logado, ou não, e se faz parte de alguma sessão.

Como estamos trabalhando com boas práticas de programação e utilizando vários padrões de design, vamos trabalhar com uma interface para fazer todo este trabalho de autenticação e gerenciamento de sessão pra gente.

Dentro da pasta **src** crie uma pasta chamada **Auth**. Dentro desta pasta cria uma interface chamada **AuthInterface.php**. Veja o conteúdo da interface:

```php
declare(strict_types = 1)

namespace SONFin\Auth;

interface AuthInterface
{
    public function login(array $credentials): bool;

    public function check(): bool;

    public function logout(): void;

}
```

Temos um método para executar o login, outro para executar o logout e um outro método para verificar se o usuário está logado ou não.

Depois de criar a interface crie uma classe, chamada **Auth**, que implemente esta interface. Veja o conteúdo da classe **src/Auth/Auth.php**:

```php
namespace SONFin\Auth;

class Auth implements \AuthInterface
{

    public function login(array $credentials): bool
    {
        // TODO: Implement login() method.
    }

    public function check(): bool
    {
        // TODO: Implement check() method.
    }

    public function logout(): void
    {
        // TODO: Implement logout() method.
    }
}
```

Nós apenas implementaremos os métodos da interface para não ter nenhum erro, mas deixaremos para desenvolver os métodos em outros módulos.

Depois de criar a interface e a classe, que a implementa, criaremos um serviço para adicionar a autenticação em nossa aplicação.

Crie o plugin **src/Plugins/AuthPlugin.php**. Veja o código abaixo:

```php
declare(strict_types=1);

namespace SONFin\Plugins;


use Interop\Container\ContainerInterface;
use SONFin\Auth\Auth;
use SONFin\ServiceContainerInterface;

class AuthPlugin implements PluginInterface
{

    public function register(ServiceContainerInterface $container)
    {
        $container->addLazy('auth', function (ContainerInterface $container) {
            return new Auth();
        });
    }
}
```

E depois de criar basta registrar no arquivo **public/index.php**, veja abaixo:

```php
use SONFin\Plugins\AuthPlugin;

$app->plugin(new AuthPlugin());
```

O objetivo de utilizar este plugin de autenticação é facilitar o processo de login.

Utilizaremos uma outra biblioteca, para executar o processo juntamente com nosso plugin, mas continuaremos nos próximos módulos.