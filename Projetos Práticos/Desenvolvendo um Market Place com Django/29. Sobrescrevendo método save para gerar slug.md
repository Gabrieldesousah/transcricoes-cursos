# Sobrescrevendo método save para gerar slug

Se você tentou criar mais do que um produto e obteve um erro, nós explicaremos o motivo.

Se você acessar o painel, no setor de edição de produtos, você vai ver que o campos **slug** ficou em branco. Este campo é muito importante para nossa aplicação porque ele ajuda a tornar o produto único e também ajuda na formação das urls amigáveis do projeto.

Para conferir o campo em branco acesse o link **http://localhost:8000/admin/portal/product/2/change/**. Lembrando que você deve estar logado.

Da maneira que está nosso código, todos os produtos que criarmos terão o slug em branco e como já possuímos um, o sistema não deixará criar outro, uma vez que este campo está setado como único **(unique)**.

Sobrescreveremos o método **save** para que possamos garantir que a cada produto criado seja gerado um novo slug, baseado no nome do produto. 

Podemos ficar tranquilos durante a edição do produto, pois não editaremos mais o slug depois que o mesmo foi criado. Por este motivo removemos o campo *slug* do formulário de edição.

### Editando portal/models.py

```python
# Importando classe slugify
from django.template.defaultfilters import slugify

class Product(models.Model):
    name = models.CharField(max_length=255)
    slug = models.SlugField(unique=True)
    user = models.ForeignKey(User)
    categories = models.ManyToManyField(Category, blank=True, related_name='categories')
    quantity = models.IntegerField(default=1)
    price = models.DecimalField(max_digits=8, decimal_places=2)
    short_description = models.CharField(max_length=255)
    description = models.TextField(null=True, blank=True)
    STATUS_CHOICES = (
        ('Active', 'Active'),
        ('Inactive', 'Inactive'),
    )
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="Inactive")

    class Meta:
        verbose_name_plural = "Products"

    def __str__(self):
        return self.name
    
    def save(self, *args, **kwargs):
        is_new = self.pk is None
        if is_new:
            super(Product, self).save()
            self.slug = '%s-%i' % (slugify(self.name), self.id)
        super(Product, self).save(*args, **kwargs)
```

A classe Product ficou desta forma, mas vamos nos atentar apenas da alteração que fizemos. Olhe o código abaixo:

```python
def save(self, *args, **kwargs):
	is_new = self.pk is None
	if is_new:
	    super(Product, self).save()
	    self.slug = '%s-%i' % (slugify(self.name), self.id)
	super(Product, self).save(*args, **kwargs)
```

Estamos sobrescrevendo o método principal onde recebemos a própria instância da classe e os argumentos, caso precisemos.

Com o código `self.pk is None` estamos verificando se existe uma **primary key** ou não. Com isso estamos verificando se a requisição se trata de um cadastro ou de uma edição de protudo, ou seja, se é um produto novo ou existente. Lembrando que todo produto existente obrigatoriamente terá uma **pk**.

> Caso seja um novo produto

A condicional verifica se a variável **is_new** é verdadeira, caso seja utilizamos o método **super** que irá executar o método principal **save**. Cuidado para não confundir com este método *save* que estamos criando, porque este é somente para sobrescrever o principal, caso seja um produto novo.

Salvamos o produto, antes da geração do slug, para que seja gerado um id, pois o slug conterá o id deste novo produto. O slug você pode criar da maneira que preferir, nós preferimos definir desta maneira.

Para criar o slug estamos utilizando o método **slugify**, então não se esqueça de importar a classe. No código acima adicionamos o exemplo da importação.

`self.slug = '%s-%i' % (slugify(self.name), self.id)`

Depois que o slug é criado nós salvamos novamente o produto para que seja salvo no banco.

> Caso seja um produto existente

Caso não seja um produto novo ele executa direto o salvamento sem setar nenhum slug, pois o mesmo já existe e já foi gravado anteriormente.

### Corrigindo erro inicial

Não conseguiremos criar o novo produto ainda, pois nosso novo método de criação de slug, conforme já falamos acima, salva o produto antes de criar o slug, portanto, ao salvar, continuaremos tendo o mesmo problema anterior, porque o slug, do novo produto, ainda estará em branco e o nosso primeiro produto também está com o slug em branco no banco de dados, por este motivo ainda não será permitido o cadastro.

Para corrigir este problema temos que acessar o painel e adicionar um slug, manualmente, ao produto que estiver com o slug vazio.

Acesse **http://localhost:8000/admin/portal/product/2/change/**, adicione um slug e salve o produto. Caso seja outro id, em seu caso, você deve acessar o id correto. Em nosso exemplo editamos o produto de id dois.

Depois de se certificar que não existe mais nenhum produto com slug em branco, você pode cadastrar seu produto normalmente e já teremos os slugs sendo criados, conforme nossa função.

Depois de criar seu produto você pode conferir o slug acessando **http://localhost:8000/admin/portal/product/** e clicando para editar o último produto criado.