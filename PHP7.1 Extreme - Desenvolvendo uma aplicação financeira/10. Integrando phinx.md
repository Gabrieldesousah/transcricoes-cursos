# Integrando phinx

Quando começamos a desenvolver uma aplicação backend, voltada para web, que tem banco de dados, a primeira coisa que pensamos é na estrutura deste banco. Esta analise inicial do banco de dados serve para termos uma noção da complexidade do sistema que será criado.

Se alguem chegar e pedir uma aplicação financeira com a linguagem PHP e nos moldes requeridos neste conteúdo, e crie seu banco de dados de forma que você não gere um SQL fixo.

1. Você criaria um SQL dinâmico no seu PHP?
2. Você vai fazer o PHP administrar as atualizações do banco de dados?

Nós temos um conceito aplicado no desenvolvimento em aplicações que usam o banco de dados. Este conceito é chamado de **migrations**.

Quando você administra o seu banco de dados, através do próprio banco de dados, e você precisa fazer uma atualização, ou manutenção, este processo irá complicar sua vida. Quem já trabalhou com projetos práticos sabe do que estamos falando, caso não tenha trabalhado ainda, você pode acreditar no que estamos dizendo.

Imagina que você tem um sistema de cadastro de clientes, e você já tem 50 campos adicionados, quando vai entregar para o seu cliente ele pede para que seja adicionado mais um campo a este cadastro. Neste momento você já está passando mal só de pensar a quantidade de alterações que aquele campo pode causar em sua aplicação.

Precisa adicionar manualmente, depois testa, adicionar o novo parâmetros nas buscas já existentes e no final ainda precisa rodar um comando, no ambiente de produção, para atualizar o banco, ou seja, muito trabalho por causa de apenas uma alteração.

O conceito de migração vem para solucionar este problema e consiste em identificar a linguagem de programação que estamos utilizando e fazer com que ela gerencie estes campos para nós.

Criaremos classes que serão capazes de gerenciar estes campos, criar tabelas, alterar, adicionar e excluir. Nós também trabalharemos com versionamento destes bancos de dados, como se fosse um Git.

Trabalha com migração é essencial, nos projetos atuais, para que você tenha este controle de banco de dados. Com este recurso você não precisa ficar se preocupando em guardar os código de criação do banco de dados, porque com esta classe você criará quantas réplicas do banco você quiser.

Como neste projeto prático nós não utilizaremos nenhum framework, utilizaremos apenas bibliotecas para que possamos criar a nossa própria base de dados. Desta forma você perceberá que existe muitas opções de bibliotecas para criarmos o nosso próprio workflow de desenvolvimento.

A primeira biblioteca que iremos instalar será o **phinx**. Com ela nós criaremos uma ferramenta para administrar as migrations do nosso projeto. Administraremos o banco de dados através do PHP.

A ferramenta irá disponibilizar uma linha de comando, já vai criar as classes de forma automática. Iremos utilizar esta biblioteca logo de cara sem ficar reinventando a roda. O objetivo principal deste conteúdo é mostrar que para desenvolver uma aplicação existem muitas bibliotecas prontas que podem nos ajudar. Você vai pesquisar a biblioteca, referente ao trabalho que quer desenvolver, e analisar se ela está sendo mantida, para não correr o risco de trabalhar com uma biblioteca que não seja compatível com o PHP 7.1, por exemplo.

Não criaremos nada do zero, utilizando PHP puro, porque senão demoraria tempo demais e o conteúdo ficaria muito extenso.

### Instalando phinx

Acesse a pasta do seu projeto e rode o seguinte comando:

`composer requiser robmorgan/phinx:0.7.1`

Você pode encontrar a documentação desta ferramenta no site: <https://phinx.org>.

Existem vários comandos que você poderá utilizar, então é muito interessante, e aconselhável, manter esta documentação salva em algum lugar de fácil acesso. Você pode precisar para consultas durante o desenvolvimento.

No github você pode encontrar uma animação com algumas instruções e mais informações: <https://github.com/robmorgan/phinx>.

Se você já trabalhou com frameworks você perceberá que não precisamos ficar presos a eles quanto temos que fazer um sistema de rotas, nem para criar as migrations. Nós aprenderemos utilizar ferramentas que suprem estas necessidades e muitas vezes o próprio framework utiliza as mesmas ferramentas.

O primeiro passo de configura, depois da instalação, será configurar as credencias do banco de dados, porque senão esta ferramenta não terá o acesso para fazer as modificações no banco.

Crie uma pasta, chamada **config**, para colocarmos qualquer informações que sejam globais, assim como credenciais. Dentro desta pasta crie um arquivo chamado **db.php** e neste arquivo definiremos as credenciais do banco de dados.

Como faremos o deploy desta aplicação, no final do conteúdo, vamos configurar dois tipos de credenciais: **desenvolvimento** e **produção**.

### Conteúdo do arquivo db.php

```
return [
    'development' => [
        'driver' => 'mysql',
        'host' => 'localhost',
        'database' => 'son_financas',
        'username' => 'root',
        'password' => 'root',
        'charset' => 'utf8',
        'collation' => 'utf8_unicode_ci'
    ]
];
```

Neste arquivo estamos definindo todas as informações necessárias para a coneção e para a criação do banco de dados. Estamos passando inclusive o parâmetro **charset** que é o tipo de codificação que o banco suporta, permitindo a adição de acentos e caractéres especiais, e também o **collation**, que está mais ligada as tabelas, permitindo que **A** não seja diferenciado de **a**, em uma busca, por exemplo. O **ci** no final da collation significa **case insensitive**.

Agora que definimos as nossas configurações, já temos o primeiro passo para trabalhar com esta biblioteca. No próximo módulo ensinaremos a executar comandos e como criamos uma primeira migração.